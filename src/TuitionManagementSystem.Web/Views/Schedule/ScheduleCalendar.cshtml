@model TuitionManagementSystem.Web.ViewModels.Schedule.ScheduleCalendarVm

@{
var isAdmin = User.IsInRole("Administrator");
var userType = User.FindFirst(TuitionManagementSystem.Web.Services.Auth.Constants.InternalClaimTypes.UserType)?.Value;
var userIdRaw = User.FindFirst(TuitionManagementSystem.Web.Services.Auth.Constants.InternalClaimTypes.UserId)?.Value;
var hasUserId = int.TryParse(userIdRaw, out var currentUserId);


var effectiveCourseId = Model.CourseId;
int? effectiveTeacherId = Model.TeacherId;
int? effectiveStudentId = Model.StudentId;

if (!isAdmin && hasUserId)
{
if (string.Equals(userType, nameof(TuitionManagementSystem.Web.Models.User.Teacher), StringComparison.OrdinalIgnoreCase))
{
effectiveTeacherId = currentUserId;
effectiveStudentId = null;
}
else if (string.Equals(userType, nameof(TuitionManagementSystem.Web.Models.User.Student), StringComparison.OrdinalIgnoreCase))
{
effectiveStudentId = currentUserId;
effectiveTeacherId = null;
}
}
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Timetable</h2>
    @* *@
    <button type="button" id="btnDownloadPdf" class="btn btn-danger">
        <i class="bi bi-file-earmark-pdf"></i> Export to PDF
    </button>
</div>

<div style="max-width: 1400px; margin: 0 auto;">
    <div id="calendar-export-container" style="background: white; padding: 10px;">
        <div id="calendar"></div>
    </div>
</div>

@section Scripts {
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');

        const courseId = '@(effectiveCourseId?.ToString() ?? "")';
        const teacherId = '@(effectiveTeacherId?.ToString() ?? "")';
        const studentId = '@(effectiveStudentId?.ToString() ?? "")';

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            timeZone: 'local',
            height: 850,
            expandRows: true,
            nowIndicator: true,
            slotMinTime: '09:00:00',
            slotMaxTime: '23:00:00',
            views: {
                dayGridMonth: { displayEventTime: false }
            },
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            eventDidMount: function(info) {
                const course = info.event.title || '';
                const classroom = (info.event.extendedProps && info.event.extendedProps.classroomName) ? info.event.extendedProps.classroomName : '';

                const start = info.event.start;
                const end = info.event.end;

                const fmt = (d) => d ? d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                const timeRange = (start && end) ? `${fmt(start)} - ${fmt(end)}` : (start ? fmt(start) : '');

                const parts = [course];
                if (classroom) parts.push(classroom);
                if (timeRange) parts.push(timeRange);

                info.el.setAttribute('title', parts.filter(Boolean).join('\n'));
            },
            events: function (info, successCallback, failureCallback) {
                const url = new URL('@Url.Action("Events", "Schedule")', window.location.origin);
                url.searchParams.set('start', info.startStr);
                url.searchParams.set('end', info.endStr);

                if (courseId) url.searchParams.set('courseId', courseId);
                if (teacherId) url.searchParams.set('teacherId', teacherId);
                if (studentId) url.searchParams.set('studentId', studentId);

                fetch(url.toString(), { headers: { 'Accept': 'application/json' } })
                    .then(r => r.ok ? r.json() : Promise.reject(r))
                    .then(data => successCallback(data))
                    .catch(err => failureCallback(err));
            }
        });

        calendar.render();
    });

    document.getElementById('btnDownloadPdf').addEventListener('click', function () {
        const element = document.getElementById('calendar-export-container');

        const opt = {
            margin:       5,
            filename:     'Timetable-Export.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  {
                scale: 2,
                useCORS: true,
                logging: false
            },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'landscape' }
        };

        html2pdf().set(opt).from(element).save();
    });
</script>
}
