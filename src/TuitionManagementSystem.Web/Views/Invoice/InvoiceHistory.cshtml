@using TuitionManagementSystem.Web.Models.Payment
@model TuitionManagementSystem.Web.Features.Invoice.ListInvoice.ListInvoiceViewModel

@{
    Layout = "_Layout";
    ViewData["Title"] = "Invoice History";
}

@section Styles {
<style>
    .invoice-card {
        transition: all 0.2s ease;
        border-left: 3px solid #0d6efd;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .invoice-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .invoice-card.paid { border-left-color: #198754; background-color: #f8fff9; }
    .invoice-card.cancelled { border-left-color: #6c757d; background-color: #f8f9fa; }
    .invoice-card.withdrawn { border-left-color: #ffc107; background-color: #fff3cd; }
    .status-badge { font-size: 0.7rem; padding: 0.2rem 0.4rem; }
</style>
}

<div class="container-fluid py-4">
    <div class="row mb-3">
        <div class="col-12">
            <h3><i class="fas fa-history me-2"></i>Invoice History</h3>
            <p class="text-muted">View your past invoices</p>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <form method="get" action="@Url.Action("InvoiceHistory", "Invoice")" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Month</label>
                    <select name="month" class="form-select" onchange="this.form.submit()">
                        <option value="">All Months</option>
                        @foreach (var month in Model.AvailableMonths)
                        {
                            var monthName = new DateTime(Model.SelectedYear, month, 1).ToString("MMMM");
                            <option value="@month" selected="@(Model.SelectedMonth == month)">@monthName</option>
                        }
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">Year</label>
                    <select name="year" class="form-select" onchange="this.form.submit()">
                        @for (var y = DateTime.Now.Year - 1; y <= DateTime.Now.Year + 1; y++)
                        {
                            <option value="@y" selected="@(Model.SelectedYear == y)">@y</option>
                        }
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select name="status" class="form-select" onchange="this.form.submit()">
                        <option value="">All Statuses</option>
                        <option value="Paid" selected="@(Model.SelectedStatus == "Paid")">Paid</option>
                        <option value="Cancelled" selected="@(Model.SelectedStatus == "Cancelled")">Cancelled</option>
                        <option value="Withdrawn" selected="@(Model.SelectedStatus == "Withdrawn")">Withdrawn</option>
                    </select>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>Invoices (@Model.Invoices.Count)
            </h5>
        </div>
        <div class="card-body p-0">
            @if (!Model.Invoices.Any())
            {
                <div class="text-center py-5">
                    <i class="fas fa-file-invoice fa-3x text-muted mb-2"></i>
                    <p class="text-muted">No invoice history found</p>
                </div>
            }
            else
            {
                <div class="list-group list-group-flush">
                    @foreach (var invoice in Model.Invoices)
                    {
                        var cardClass = invoice.Status == InvoiceStatus.Paid ? "paid" :
                            invoice.Status == InvoiceStatus.Cancelled ? "cancelled" :
                            invoice.Status == InvoiceStatus.Withdrawn ? "withdrawn" : "";

                        <div class="list-group-item p-0">
                            <div class="invoice-card card m-2 @cardClass">
                                <div class="card-body d-flex justify-content-between align-items-center p-2">
                                    <div>
                                        <h6 class="mb-0 text-muted">@invoice.SubjectName</h6>
                                        <h5 class="mb-1">@invoice.CourseName</h5>
                                        <p class="text-muted small">@invoice.StudentName</p>
                                        <span class="badge @(invoice.Status == InvoiceStatus.Paid ? "bg-success" :
                                                           invoice.Status == InvoiceStatus.Cancelled ? "bg-secondary" :
                                                           "bg-warning") status-badge">
                                            @invoice.Status
                                        </span>
                                    </div>
                                    <div class="text-end">
                                        <p class="mb-1 small text-muted">Invoiced</p>
                                        <p class="mb-1">@invoice.InvoicedAt.ToString("MMM dd, yyyy")</p>

                                        @if (invoice.Status == InvoiceStatus.Cancelled && invoice.CancelledAt.HasValue)
                                        {
                                            <p class="mb-1 small text-muted">Cancelled At</p>
                                            <p class="mb-1 text-secondary">@invoice.CancelledAt.Value.ToString("MMM dd, yyyy")</p>
                                        }
                                        else if (invoice.Status == InvoiceStatus.Paid)
                                        {
                                            <a asp-controller="Payment" asp-action="Index" asp-route-id="@invoice.PaymentId"
                                               class="btn btn-sm btn-outline-primary">
                                                View Payment Details
                                            </a>
                                        }
                                        else if (invoice.Status != InvoiceStatus.Paid)
                                        {
                                            <p class="mb-1 small text-muted">Due</p>
                                            <p class="mb-1">@(invoice.DueAt?.ToString("MMM dd, yyyy") ?? "N/A")</p>
                                        }

                                        <h5 class="text-primary mt-1">RM@(invoice.Amount.ToString("0.00"))</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>
