@using TuitionManagementSystem.Web.Models.Payment
@model TuitionManagementSystem.Web.Features.Invoice.ListInvoice.ListInvoiceViewModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Pending Fees";
}

@section Styles {
    <style>
        .invoice-card {
            transition: all 0.3s ease;
            border-left: 4px solid #0d6efd;
        }

        .invoice-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .invoice-card.overdue {
            border-left-color: #dc3545;
            background-color: #fff5f5;
        }

        .invoice-card.pending {
            border-left-color: #ffc107;
        }

        .invoice-card.paid {
            border-left-color: #198754;
            opacity: 0.8;
        }

        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        .checkout-sidebar {
            position: sticky;
            top: 20px;
        }

        .filter-badge {
            cursor: pointer;
        }

        .filter-badge:hover {
            opacity: 0.8;
        }
    </style>
}

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-2">
                <i class="fas fa-file-invoice-dollar me-2"></i>Tuition Fees
            </h1>
            <p class="text-muted mb-0">View and manage your pending and overdue tuition fees</p>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>Filters
            </h5>
        </div>
        <div class="card-body">
            <form id="filterForm" method="get" action="@Url.Action("ListInvoices", "Invoice")" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Month</label>
                    <select name="month" class="form-select" onchange="this.form.submit()">
                        <option value="">All Months</option>
                        @foreach (var month in Model.AvailableMonths)
                        {
                            var monthName = new DateTime(Model.SelectedYear, month, 1).ToString("MMMM");
                            <option value="@month" selected="@(Model.SelectedMonth == month)">@monthName</option>
                        }
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">Year</label>
                    <select name="year" class="form-select" onchange="this.form.submit()">
                        <option value="@(DateTime.Now.Year - 1)"
                                selected="@(Model.SelectedYear == DateTime.Now.Year - 1)">@(DateTime.Now.Year - 1)</option>
                        <option value="@DateTime.Now.Year"
                                selected="@(Model.SelectedYear == DateTime.Now.Year)">@DateTime.Now.Year</option>
                        <option value="@(DateTime.Now.Year + 1)"
                                selected="@(Model.SelectedYear == DateTime.Now.Year + 1)">@(DateTime.Now.Year + 1)</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Show</label>
                    <div class="btn-group w-100" role="group">
                        <input type="checkbox" class="btn-check" name="overdueOnly" id="overdueOnly"
                               value="true" @(Model.OverdueOnly ? "checked" : "") onchange="this.form.submit()">
                        <label class="btn btn-outline-danger" for="overdueOnly">
                            <i class="fas fa-exclamation-triangle me-1"></i>Overdue Only
                        </label>

                        <input type="checkbox" class="btn-check" name="pendingOnly" id="pendingOnly"
                               value="true" @(Model.PendingOnly ? "checked" : "") onchange="this.form.submit()">
                        <label class="btn btn-outline-warning" for="pendingOnly">
                            <i class="fas fa-clock me-1"></i>Pending Only
                        </label>
                    </div>
                </div>
            </form>

            <div class="mt-3">
                @if (Model.OverdueOnly)
                {
                    <span class="badge bg-danger filter-badge me-2 mb-2">
                        <i class="fas fa-exclamation-triangle me-1"></i>Overdue Only
                        <a href="@Url.Action("ListInvoices", "Invoice", new
                                 {
                                     month = Model.SelectedMonth,
                                     year = Model.SelectedYear,
                                     pendingOnly = Model.PendingOnly
                                 })" class="text-white ms-2" title="Remove filter">×</a>
                    </span>
                }
                @if (Model.PendingOnly)
                {
                    <span class="badge bg-warning filter-badge me-2 mb-2">
                        <i class="fas fa-clock me-1"></i>Pending Only
                        <a href="@Url.Action("ListInvoices", "Invoice", new
                                 {
                                     month = Model.SelectedMonth,
                                     year = Model.SelectedYear,
                                     overdueOnly = Model.OverdueOnly
                                 })" class="text-white ms-2" title="Remove filter">×</a>
                    </span>
                }
                @if (Model.SelectedMonth.HasValue)
                {
                    var monthName = new DateTime(Model.SelectedYear, Model.SelectedMonth.Value, 1).ToString("MMMM");
                    <span class="badge bg-info filter-badge me-2 mb-2">
                        <i class="fas fa-calendar-alt me-1"></i>@monthName
                        <a href="@Url.Action("ListInvoices", "Invoice", new
                                 {
                                     year = Model.SelectedYear,
                                     overdueOnly = Model.OverdueOnly,
                                     pendingOnly = Model.PendingOnly
                                 })" class="text-white ms-2" title="Remove filter">×</a>
                    </span>
                }
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Tuition Fees (@Model.Invoices.Count)
                    </h5>
                    @if (Model.Invoices.Any(i => i.Status == InvoiceStatus.Pending || i.Status == InvoiceStatus.Overdue))
                    {
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAllInvoices">
                            <label class="form-check-label text-muted" for="selectAllInvoices">
                                Select All
                            </label>
                        </div>
                    }
                </div>
                <div class="card-body p-0">
                    @{
                        var displayInvoices = Model.Invoices
                            .Where(i => i.Status == InvoiceStatus.Pending || i.Status == InvoiceStatus.Overdue)
                            .ToList();
                    }

                    @if (!displayInvoices.Any())
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No pending or overdue fees found with current filters</p>
                            <a href="@Url.Action("ListInvoices", "Invoice")" class="btn btn-primary">
                                Clear Filters
                            </a>
                        </div>
                    }
                    else
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var invoice in displayInvoices)
                            {
                                var cardClass = invoice.Status == InvoiceStatus.Overdue ? "overdue" : "pending";
                                var isPayable = invoice.Status == InvoiceStatus.Pending || invoice.Status == InvoiceStatus.Overdue;

                                <div class="list-group-item p-0">
                                    <div class="invoice-card card m-3 @cardClass">
                                        <div class="card-body">
                                            <div class="row align-items-center">
                                                <div class="col-auto">
                                                    @if (isPayable)
                                                    {
                                                        <div class="form-check">
                                                            <input class="form-check-input invoice-checkbox"
                                                                   type="checkbox"
                                                                   value="@invoice.InvoiceId"
                                                                   id="invoice-@invoice.InvoiceId"
                                                                   data-amount="@invoice.Amount">
                                                        </div>
                                                    }
                                                </div>

                                                <!-- Invoice Info -->
                                                <div class="col">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <h6 class="mb-1 text-muted small">@invoice.SubjectName</h6>
                                                            <h5 class="mb-1">@invoice.CourseName</h5>
                                                            <p class="text-muted mb-1 small">
                                                                <i class="fas fa-user-graduate me-1"></i>
                                                                @invoice.StudentName
                                                            </p>
                                                            <span
                                                                class="badge @(invoice.Status == InvoiceStatus.Pending ? "bg-warning" : "bg-danger") status-badge">
                                                                @invoice.Status
                                                                @if (invoice.Status == InvoiceStatus.Overdue)
                                                                {
                                                                    <i class="fas fa-exclamation-circle ms-1"></i>
                                                                }
                                                            </span>
                                                        </div>

                                                        <div class="col-md-6">
                                                            <div class="row text-end">
                                                                <div class="col-6">
                                                                    <small class="text-muted">Invoiced</small>
                                                                    <p class="mb-0">@invoice.InvoicedAt.ToString("MMM dd, yyyy")</p>
                                                                </div>
                                                                <div class="col-6">
                                                                    <small class="text-muted">Due Date</small>
                                                                    <p class="mb-0 @(invoice.Status == InvoiceStatus.Overdue ? "text-danger fw-bold" : "")">
                                                                        @(invoice.DueAt?.ToString("MMM dd, yyyy") ?? "N/A")
                                                                        @if (invoice.Status == InvoiceStatus.Overdue)
                                                                        {
                                                                            <i class="fas fa-exclamation-triangle ms-1"></i>
                                                                        }
                                                                    </p>
                                                                </div>
                                                                <div class="col-12 mt-2">
                                                                    <h5 class="text-primary">
                                                                        RM@(invoice.Amount.ToString("0.00"))</h5>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="col-auto">
                                                    @if (isPayable)
                                                    {
                                                        <button class="btn btn-sm btn-primary pay-single"
                                                                data-invoice-id="@invoice.InvoiceId"
                                                                data-amount="@invoice.Amount">
                                                            <i class="fas fa-credit-card me-1"></i>Pay Now
                                                        </button>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card checkout-sidebar">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-shopping-cart me-2"></i>Payment Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-credit-card fa-3x text-primary mb-3"></i>
                        <h4>Pay Selected Tuition Fees</h4>
                        <p class="text-muted">Select fees to proceed with payment</p>
                    </div>

                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Selected Fees:</span>
                            <span class="fw-bold" id="selectedCount">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span id="subtotal">RM0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Processing Fee (2%):</span>
                            <span id="processingFee">RM0.00</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <h5>Total Amount:</h5>
                            <h4 class="text-primary" id="totalAmount">RM0.00</h4>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button id="checkoutBtn" class="btn btn-success btn-lg" disabled>
                            <i class="fas fa-lock me-2"></i>Checkout Now
                        </button>
                        <button id="clearSelectionBtn" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Clear Selection
                        </button>
                    </div>

                    <div class="mt-4 text-center">
                        <p class="small text-muted">
                            <i class="fas fa-shield-alt me-1"></i>
                            Secure payment powered by Stripe
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            function updatePaymentSummary() {
                let total = 0;
                let selectedCount = 0;

                $('.invoice-checkbox:checked').each(function () {
                    total += parseFloat($(this).data('amount'));
                    selectedCount++;
                });

                const processingFee = total * 0.02;
                const totalAmount = total + processingFee;

                $('#selectedCount').text(selectedCount);
                $('#subtotal').text('RM' + total.toFixed(2));
                $('#processingFee').text('RM' + processingFee.toFixed(2));
                $('#totalAmount').text('RM' + totalAmount.toFixed(2));

                $('#checkoutBtn').prop('disabled', selectedCount === 0);
            }

            $('#selectAllInvoices').change(function () {
                const isChecked = $(this).prop('checked');
                $('.invoice-checkbox').prop('checked', isChecked);
                updatePaymentSummary();
            });

            $(document).on('change', '.invoice-checkbox', function () {
                updatePaymentSummary();

                const allCheckboxes = $('.invoice-checkbox');
                const checkedCount = allCheckboxes.filter(':checked').length;
                const totalCheckboxes = allCheckboxes.length;

                $('#selectAllInvoices').prop('checked',
                    totalCheckboxes > 0 && checkedCount === totalCheckboxes);
            });

            $('#clearSelectionBtn').click(function () {
                $('.invoice-checkbox').prop('checked', false);
                $('#selectAllInvoices').prop('checked', false);
                updatePaymentSummary();
            });

            $('#checkoutBtn').click(function () {
                const selectedInvoices = [];
                let totalAmount = 0;

                $('.invoice-checkbox:checked').each(function () {
                    selectedInvoices.push(parseInt($(this).val()));
                    totalAmount += parseFloat($(this).data('amount'));
                });

                if (selectedInvoices.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'No invoices selected',
                        text: 'Please select at least one invoice to pay.'
                    });
                    return;
                }

                Swal.fire({
                    title: `Proceed to pay ${selectedInvoices.length} invoice(s)?`,
                    text: `Total Amount: RM${totalAmount.toFixed(2)}`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, pay now',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '@Url.Action("PaySelectedInvoices", "Invoice")',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                InvoiceIds: selectedInvoices,
                            }),
                            success: function (response) {
                                if (response.success) {
                                    selectedInvoices.forEach(id => {
                                        const card = $('#invoice-' + id).closest('.invoice-card');
                                        card.removeClass('pending overdue').addClass('paid');
                                        card.find('.status-badge')
                                            .removeClass('bg-warning bg-danger')
                                            .addClass('bg-success')
                                            .text('Paid');
                                        card.find('.pay-single').remove();
                                        $('#invoice-' + id).prop('disabled', true).prop('checked', false);
                                    });

                                    updatePaymentSummary();

                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Payment initiated!',
                                        text: 'Your payment has been processed successfully.',
                                        showConfirmButton: false,
                                        timer: 1500
                                    }).then(() => {
                                        location.reload();
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: response.message
                                    });
                                }
                            },
                            error: function () {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Oops!',
                                    text: 'An error occurred. Please try again.'
                                });
                            }
                        });
                    }
                });
            });

            $(document).on('click', '.pay-single', function () {
                const invoiceId = $(this).data('invoice-id');
                const amount = $(this).data('amount');

                Swal.fire({
                    title: `Pay invoice #${invoiceId}?`,
                    text: `Amount: RM${amount.toFixed(2)}`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, pay now',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '@Url.Action("PaySelectedInvoices", "Invoice")',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                InvoiceIds: [invoiceId],
                            }),
                            success: function (response) {
                                if (response.success) {
                                    const card = $('#invoice-' + invoiceId).closest('.invoice-card');
                                    card.removeClass('pending overdue').addClass('paid');
                                    card.find('.status-badge')
                                        .removeClass('bg-warning bg-danger')
                                        .addClass('bg-success')
                                        .text('Paid');
                                    $(this).remove();
                                    $('#invoice-' + invoiceId).prop('disabled', true).prop('checked', false);

                                    updatePaymentSummary();

                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Payment initiated!',
                                        text: 'Your payment has been processed successfully.',
                                        showConfirmButton: false,
                                        timer: 1500
                                    }).then(() => {
                                        location.reload();
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: response.message
                                    });
                                }
                            },
                            error: function () {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Oops!',
                                    text: 'An error occurred. Please try again.'
                                });
                            }
                        });
                    }
                });
            });

            $('#overdueOnly').change(function () {
                if ($(this).prop('checked')) {
                    $('#pendingOnly').prop('checked', false);
                }
                $('#filterForm').submit();
            });

            $('#pendingOnly').change(function () {
                if ($(this).prop('checked')) {
                    $('#overdueOnly').prop('checked', false);
                }
                $('#filterForm').submit();
            });

            updatePaymentSummary();
        });
    </script>
}
