@using TuitionManagementSystem.Web.Services.Auth.Extensions
@model TuitionManagementSystem.Web.Features.Accounts.AccountProfileViewModel

@{
    ViewData["Title"] = "Account Profile";
}

<div class="min-vh-100 d-flex align-items-center justify-content-center bg-light">
    <div class="card shadow-lg border-0 rounded-4" style="max-width: 600px; width: 100%;">

        <!-- HEADER -->
        <div class="card-header bg-primary text-white text-center py-4 rounded-top-4">
            <h3>@User.GetUsername()</h3>
        </div>

        <div class="card-body">
            <form asp-controller="AccountsApi" asp-action="UpdateProfile" id="profileForm">
                <div class="mb-3">
                    <label asp-for="Username"></label>
                    <input asp-for="Username" id="username" class="form-control" disabled/>
                    <span asp-validation-for="Username"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Email"></label>
                    <input asp-for="Email" id="email" class="form-control" disabled/>
                    <span asp-validation-for="Email"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Password"></label>
                    <input asp-for="Password" id="password" placeholder="*******" class="form-control" disabled/>
                    <span asp-validation-for="Password"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="ConfirmPassword"></label>
                    <input asp-for="ConfirmPassword" id="confirmPassword" placeholder="*******" class="form-control" disabled/>
                    <span asp-validation-for="ConfirmPassword"></span>
                </div>

                <div class="d-flex justify-content-between">
                    <div>
                        <button type="button"
                                id="editProfileBtn"
                                class="btn btn-primary">
                            Edit Profile
                        </button>
                    </div>

                    <div>
                        <button type="button"
                                id="changePasswordBtn"
                                class="btn btn-secondary">
                            Change Password
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    $(function () {

        let editMode = false;
        let originalValues = {};

        function enterEditMode() {
            editMode = true;

            $("#profileForm input")
                .not("#password")
                .prop("disabled", false);

            $("#changePasswordBtn")
                .prop("disabled", true)
                .css({ opacity: 0.7, cursor: "not-allowed" });

            $("#editProfileBtn").text("Save Changes");
        }

        function exitEditMode() {
            editMode = false;

            $("#profileForm input").prop("disabled", true);
            $("#confirmPassword").val("");

            $("#changePasswordBtn")
                .prop("disabled", false)
                .css({ opacity: "", cursor: "" });

            $("#editProfileBtn").text("Edit Profile");
            $("#cancelBtn").remove();
        }

        $("#editProfileBtn").click(function () {

            const $inputs = $("#profileForm input").not("#password");
            const $editBtn = $(this);

            if (!editMode) {

                $inputs.each(function () {
                    originalValues[this.id] = $(this).val();
                });

                enterEditMode();

                if ($("#cancelBtn").length === 0) {
                    $("<button>", {
                        id: "cancelBtn",
                        type: "button",
                        class: "btn btn-danger ms-2",
                        text: "Cancel"
                    })
                        .insertAfter($editBtn)
                        .on("click", function () {

                            $inputs.each(function () {
                                $(this)
                                    .val(originalValues[this.id])
                                    .prop("disabled", true);
                            });

                            exitEditMode();
                        });
                }

                return;
            }

            const confirmPwd = $("#confirmPassword").val().trim();

            if (!confirmPwd) {
                Swal.fire(
                    "Error",
                    "Please enter your current password to confirm changes.",
                    "error"
                );
                return;
            }

            const formData = {
                Username: $("#username").val(),
                Email: $("#email").val(),
                ConfirmPassword: confirmPwd
            };

            $.ajax({
                url: '@Url.Action("UpdateProfile", "AccountsApi")',
                type: 'POST',
                data: formData,
                success: function (res) {
                    if (res.success) {
                        Swal.fire("Success", res.message, "success")
                            .then(() => {
                                exitEditMode();
                                location.reload();
                            });
                    } else {
                        Swal.fire(
                            "Error",
                            res.message.replace(/\n/g, "<br>"),
                            "error"
                        );
                        enterEditMode();
                    }
                }
            });
        });

        $("#changePasswordBtn").click(function () {

            if ($(this).prop("disabled")) return;
            const route = this.action;
            const method = this.method;

            Swal.fire({
                title: 'Change Password',
                html: `
            <input type="password" id="currentPwd" class="swal2-input" placeholder="Current Password">
            <input type="password" id="newPwd" class="swal2-input" placeholder="New Password">
            <input type="password" id="confirmPwd" class="swal2-input" placeholder="Confirm New Password">
        `,
                showCancelButton: true,
                confirmButtonText: 'Change',
                focusConfirm: false,

                preConfirm: () => {
                    const current = $("#currentPwd").val();
                    const newPass = $("#newPwd").val();
                    const confirm = $("#confirmPwd").val();

                    if (!current || !newPass || !confirm) {
                        Swal.showValidationMessage("All fields are required");
                        return false;
                    }

                    if (newPass.length < 6) {
                        Swal.showValidationMessage("New password must be at least 6 characters");
                        return false;
                    }

                    if (newPass !== confirm) {
                        Swal.showValidationMessage("Passwords do not match");
                        return false;
                    }

                    return {
                        currentPassword: current,
                        newPassword: newPass,
                        ConfirmPassword: confirm
                    };
                }
            }).then(result => {

                if (!result.isConfirmed) return;

                $.ajax({
                    url: route,
                    type: method,
                    data: result.value,
                    success: function (res) {
                        if (res.success) {
                            Swal.fire("Success", res.message, "success");
                        } else {
                            Swal.fire("Error", res.message, "error");
                        }
                    }
                });
            });
        });
    });
</script>
}
