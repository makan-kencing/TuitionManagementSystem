@model IEnumerable<TuitionManagementSystem.Web.Features.Enrollment.ViewEnrollment.ViewEnrollmentResponse>

<h2>Enrollments</h2>

@if (!Model.Any())
{
    <div class="alert alert-warning">
        @ViewBag.Message
    </div>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Enrollment ID</th>
                <th>Course</th>
                <th>Classroom</th>
                <th>Enrolled At</th>
                <th>Days Since</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var enrollment in Model)
        {
            var daysSinceEnrollment = (DateTime.UtcNow - enrollment.EnrolledAt).Days;
            var isActive = enrollment.Status == TuitionManagementSystem.Web.Models.Class.Enrollment.EnrollmentStatus.Active;
            var showCancelButton = daysSinceEnrollment <= 14 && isActive;
            var showWithdrawButton = daysSinceEnrollment > 14 && isActive;

            <tr data-enrollment-id="@enrollment.EnrollmentId">
                <td>@enrollment.EnrollmentId</td>
                <td>@enrollment.CourseName</td>
                <td>@enrollment.ClassroomName</td>
                <td>@enrollment.EnrolledAt.ToString("dd MMM yyyy")</td>
                <td>@daysSinceEnrollment days</td>
                <td>@enrollment.Status</td>
                <td>
                    @if (showCancelButton)
                    {
                        <button class="btn btn-warning btn-sm markEnrollmentBtn" data-action="Cancelled">
                            Cancel
                        </button>
                    }
                    else if (showWithdrawButton)
                    {
                        <button class="btn btn-danger btn-sm markEnrollmentBtn" data-action="Withdrawn">
                            Withdraw
                        </button>
                    }
                    else
                    {
                        <span class="text-muted">No action</span>
                    }
                </td>
            </tr>
        }
        </tbody>
    </table>
}

<script>
$(document).on("click", ".markEnrollmentBtn", async function() {
    const row = $(this).closest("tr");
    const enrollmentId = row.data("enrollment-id");
    const action = $(this).data("action");

    const actionText = action.toLowerCase();
    const actionTitle = action === "Cancelled" ? "Cancel" : "Withdraw";

    const confirmed = await Swal.fire({
        title: `Are you sure?`,
        text: `This will ${actionText} the enrollment. ${action === "Withdrawn" ? "Note: Withdrawal is only allowed after 2 weeks of enrollment." : ""}`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: action === "Cancelled" ? "#f39c12" : "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: `Yes, ${actionText} it!`
    });

    if (confirmed.isConfirmed) {
        try {
            const response = await fetch("/enrollment/mark", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    enrollmentId: enrollmentId,
                    status: action
                })
            });

            const data = await response.json();

            if (response.ok) {
                Swal.fire({
                    icon: "success",
                    title: `${actionTitle}ed`,
                    text: data.message
                }).then(() => {
                    location.reload();
                });
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: data.message || (data.errors ? data.errors.join(", ") : "Unknown error")
                });
            }
        } catch (err) {
            Swal.fire({
                icon: "error",
                title: "Error",
                text: "Something went wrong"
            });
        }
    }
});
</script>
