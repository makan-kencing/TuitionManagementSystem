@model IEnumerable<TuitionManagementSystem.Web.Features.Enrollment.ViewEnrollment.ViewEnrollmentResponse>

<h2>Enrollments</h2>

@if (!Model.Any())
{
    <div class="alert alert-warning">
        @ViewBag.Message
    </div>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Enrollment ID</th>
                <th>Course</th>
                <th>Enrolled At</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var enrollment in Model)
        {
            <tr data-enrollment-id="@enrollment.EnrollmentId">
                <td>@enrollment.EnrollmentId</td>
                <td>@enrollment.CourseName</td>
                <td>@enrollment.EnrolledAt.ToString("dd MMM yyyy")</td>
                <td>
                    <button class="btn btn-danger btn-sm cancelEnrollmentBtn">
                        Cancel
                    </button>
                </td>
            </tr>
        }
        </tbody>
    </table>
}
    <script>
$(document).on("click", ".cancelEnrollmentBtn", async function() {
    const row = $(this).closest("tr");
    const enrollmentId = row.data("enrollment-id");

    const confirmed = await Swal.fire({
        title: "Are you sure?",
        text: "This will cancel the enrollment.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "Yes, cancel it!"
    });

    if (confirmed.isConfirmed) {
        try {
            const response = await fetch("/enrollment/cancel", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ enrollmentId })
            });

            const data = await response.json();

            if (response.ok) {
                Swal.fire({
                    icon: "success",
                    title: "Cancelled",
                    text: data.message
                });

                // remove row from table
                row.remove();
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: data.message || data.errors.join(", ")
                });
            }
        } catch (err) {
            Swal.fire({
                icon: "error",
                title: "Error",
                text: "Something went wrong"
            });
        }
    }
        });
</script>
