@model IEnumerable<TuitionManagementSystem.Web.Features.Enrollment.ViewEnrollment.ViewEnrollmentResponse>
@using TuitionManagementSystem.Web.Models.Class

@{
    var ordered = Model
        .OrderByDescending(e => e.Status == Enrollment.EnrollmentStatus.Active)
        .ThenByDescending(e => e.EnrolledAt)
        .ToList();
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">My Enrollments</h5>
    <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="toggleInactive">
        <label class="form-check-label">Show inactive</label>
    </div>
</div>

<div class="row g-3" id="enrollmentCards">
@foreach (var e in ordered)
{
    var daysSinceEnrollment = (DateTime.UtcNow - e.EnrolledAt).Days;
    var isActive = e.Status == Enrollment.EnrollmentStatus.Active;

    var showCancelButton = isActive && daysSinceEnrollment <= 14;
    var showWithdrawButton = isActive && daysSinceEnrollment > 14;

    var isInactive = !isActive;
    var cardClass = e.Status switch
    {
        Enrollment.EnrollmentStatus.Active => "border-success",
        Enrollment.EnrollmentStatus.Cancelled => "border-secondary opacity-50 inactive-card",
        Enrollment.EnrollmentStatus.Withdrawn => "border-danger opacity-50 inactive-card",
        _ => ""
    };

    <div class="col-md-6 enrollment-item @(isInactive ? "d-none" : "")">
        <div class="card h-100 @cardClass">
            <div class="card-body">

                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title mb-0">@e.CourseName</h5>
                    <span class="badge bg-@(isActive ? "success" : "secondary")">
                        @e.Status
                    </span>
                </div>

                <p class="mb-1 text-muted">
                    Classroom: <strong>@e.ClassroomName</strong>
                </p>

                <p class="mb-1">
                    Enrolled: @e.EnrolledAt.ToString("dd MMM yyyy")
                </p>

                <p class="mb-3">
                    Days since: <strong>@daysSinceEnrollment</strong>
                </p>

                <div class="d-flex gap-2">
                    @if (showCancelButton)
                    {
                        <button class="btn btn-outline-warning btn-sm markEnrollmentBtn"
                                data-enrollment-id="@e.EnrollmentId"
                                data-action="Cancelled">
                            Cancel
                        </button>
                    }
                    else if (showWithdrawButton)
                    {
                        <button class="btn btn-outline-danger btn-sm markEnrollmentBtn"
                                data-enrollment-id="@e.EnrollmentId"
                                data-action="Withdrawn">
                            Withdraw
                        </button>
                    }
                    else
                    {
                        <span class="text-muted">No action</span>
                    }
                </div>

            </div>
        </div>
    </div>
}
</div>

<script>
    $("#toggleInactive").on("change", function () {
        $(".inactive-card").closest(".enrollment-item")
            .toggleClass("d-none", !this.checked);
    });

    $(document).on("click", ".markEnrollmentBtn", async function () {
        const id = $(this).data("enrollment-id");
        const action = $(this).data("action");

        const actionText = action === "Cancelled" ? "cancel" : "withdraw";
        const actionTitle = action === "Cancelled" ? "Cancel" : "Withdraw";

        const confirmed = await Swal.fire({
            title: "Are you sure?",
            text: `This will ${actionText} the enrollment.` +
                (action === "Withdrawn"
                    ? " Note: Withdrawal is only allowed after 2 weeks of enrollment."
                    : ""),
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: action === "Cancelled" ? "#f39c12" : "#d33",
            confirmButtonText: `Yes, ${actionText} it`
        });

        if (!confirmed.isConfirmed) return;

        const res = await fetch("/enrollment/mark", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ enrollmentId: id, status: action })
        });

        const data = await res.json();

        if (res.ok) {
            Swal.fire("Success", data.message, "success")
                .then(() => location.reload());
        } else {
            const msg = data?.message || data?.errors?.join(", ") || "Failed";
            Swal.fire("Error", msg, "error");
        }
    });

    $(document).on("click", ".markEnrollmentBtn", async function () {
        const id = $(this).data("enrollment-id");
        const action = $(this).data("action");


        const confirmed = await Swal.fire({
            title: "Are you sure?",
            text: `The enrollment will be ${action.toLowerCase()}`,
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes"
        });


        if (!confirmed.isConfirmed) return;


        const res = await fetch("/enrollment/mark", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({enrollmentId: id, status: action})
        });


        const data = await res.json();


        if (res.ok) {
            Swal.fire("Success", data.message, "success")
                .then(() => location.reload());
        } else {
            Swal.fire("Error", data.message || "Failed", "error");
        }
    });
</script>
