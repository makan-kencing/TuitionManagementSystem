@model dynamic
@{
ViewData["Title"] = "Course Enrollments";
var courseId = ViewBag.CourseId;
Layout = "_Layout";
}

@section Styles {
<style>
    .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .progress {
        min-width: 100px;
        background-color: #e9ecef;
    }
    .progress-bar {
        transition: width 0.6s ease;
    }
    .table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
    }
    .table td {
        vertical-align: middle;
    }
    .badge-attendance {
        font-size: 0.85em;
        padding: 0.35em 0.65em;
    }
    .enrollment-stats {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .stat-card {
        text-align: center;
        padding: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
    }
    .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
        margin-top: 5px;
    }
    .action-buttons .btn {
        min-width: 100px;
    }
    .days-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    .days-new {
        background-color: #d1ecf1;
        color: #0c5460;
    }
    .days-medium {
        background-color: #fff3cd;
        color: #856404;
    }
    .days-old {
        background-color: #f8d7da;
        color: #721c24;
    }
    @@media (max-width: 768px) {
        .table-responsive {
            font-size: 0.9rem;
        }
        .stat-card {
            margin-bottom: 10px;
        }
        .action-buttons .btn {
            min-width: 80px;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
    }
</style>
}

<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/courses">Courses</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Enrollment Details</li>
                </ol>
            </nav>
            <h2 class="mb-0" id="courseTitle">
                <i class="fas fa-book me-2"></i>Loading Course Details...
            </h2>
            <p class="text-muted mb-0" id="subjectInfo"></p>
        </div>
        <div class="action-buttons">
            <button type="button" class="btn btn-outline-secondary me-2" onclick="refreshEnrollments()" id="refreshBtn">
                <i class="fas fa-sync-alt me-1"></i> Refresh
            </button>
            <a href="/courses" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-1"></i> Back to Courses
            </a>
        </div>
    </div>

    <div class="row mb-4" id="statsContainer" style="display: none;">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value" id="totalStudents">0</div>
                <div class="stat-label">Total Students</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value" id="avgAttendance">0%</div>
                <div class="stat-label">Average Attendance</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value" id="totalSessions">0</div>
                <div class="stat-label">Total Sessions</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value" id="activeEnrollments">0</div>
                <div class="stat-label">Active Enrollments</div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>Enrolled Students
                </h5>
                <div class="d-flex align-items-center">
                    <div class="input-group input-group-sm" style="width: 250px;">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" placeholder="Search students..." id="searchInput">
                    </div>
                </div>
            </div>
        </div>

        <div class="card-body">
            <div id="loading" class="text-center p-5">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading course enrollment data...</p>
            </div>

            <div id="enrollments-container" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-hover" id="enrollments-table">
                        <thead>
                        <tr>
                            <th>Student</th>
                            <th>Enrollment Date</th>
                            <th>Duration</th>
                            <th>Attendance</th>
                            <th class="text-center">Sessions</th>
                            <th class="text-center">Actions</th>
                        </tr>
                        </thead>
                        <tbody id="enrollments-body"></tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="text-muted" id="enrollmentCount">Showing 0 students</div>
                    <div>
                        <span class="badge bg-success me-2"><i class="fas fa-circle me-1"></i>Good (â‰¥80%)</span>
                        <span class="badge bg-warning me-2"><i class="fas fa-circle me-1"></i>Fair (60-79%)</span>
                        <span class="badge bg-danger"><i class="fas fa-circle me-1"></i>Poor (&lt;60%)</span>
                    </div>
                </div>
            </div>

            <div id="no-enrollments" class="text-center p-5" style="display: none;">
                <div class="empty-state">
                    <i class="fas fa-users-slash fa-4x text-muted mb-4"></i>
                    <h4 class="text-muted">No Active Enrollments</h4>
                    <p class="text-muted">There are no active enrollments for this course yet.</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let currentEnrollmentId = 0;
    let currentAction = '';
    let allEnrollments = [];
    let courseInfo = {};

    $(document).ready(function() {
        loadEnrollments();

        $('#searchInput').on('keyup', function() {
            filterTable($(this).val());
        });
    });

    function loadEnrollments() {
        showLoading();

        $.ajax({
            url: `/enrollment/api/course/@courseId/enrollments`,
            type: 'GET',
            beforeSend: function() {
                $('#refreshBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Refreshing...');
            },
            success: function(response) {
                allEnrollments = response.enrollments || [];
                courseInfo = response.courseInfo || {};

                // Update course title and subject
                if (courseInfo.courseName) {
                    $('#courseTitle').html(`<i class="fas fa-book me-2"></i>${courseInfo.courseName}`);
                }
                if (courseInfo.subjectName) {
                    $('#subjectInfo').html(`<i class="fas fa-graduation-cap me-1"></i>${courseInfo.subjectName}`);
                }

                if (allEnrollments.length > 0) {
                    updateStats(allEnrollments);
                    populateTable(allEnrollments);
                    $('#statsContainer').show();
                    $('#enrollments-container').show();
                    $('#no-enrollments').hide();
                } else {
                    $('#enrollments-container').hide();
                    $('#no-enrollments').show();
                    $('#statsContainer').hide();
                }
            },
            error: function(xhr) {
                showError('Failed to load enrollment data');
            },
            complete: function() {
                $('#refreshBtn').prop('disabled', false).html('<i class="fas fa-sync-alt me-1"></i> Refresh');
                $('#loading').hide();
            }
        });
    }

    function updateStats(enrollments) {
        const totalStudents = enrollments.length;
        const totalSessions = enrollments[0]?.totalSessions || 0;

        const avgAttendance = enrollments.length > 0
            ? (enrollments.reduce((sum, e) => sum + e.attendancePercentage, 0) / enrollments.length).toFixed(1)
            : 0;

        $('#totalStudents').text(totalStudents);
        $('#avgAttendance').text(avgAttendance + '%');
        $('#totalSessions').text(totalSessions);
        $('#activeEnrollments').text(totalStudents);
        $('#enrollmentCount').text(`Showing ${totalStudents} student${totalStudents !== 1 ? 's' : ''}`);
    }

    function populateTable(enrollments) {
        const tbody = $('#enrollments-body');
        tbody.empty();

        enrollments.forEach(enrollment => {
            const enrolledDate = new Date(enrollment.enrolledAt);
            const formattedDate = enrolledDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });

            const daysSince = enrollment.daysSinceEnrolled;
            const attendanceColor = getAttendanceColor(enrollment.attendancePercentage);
            const durationBadge = getDurationBadge(daysSince);

            const initials = enrollment.studentName
                .split(' ')
                .map(n => n[0])
                .join('')
                .toUpperCase()
                .substring(0, 2);

            const row = `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div>
                                <div class="fw-bold">${enrollment.studentName}</div>
                                <small class="text-muted">ID: ${enrollment.studentId}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>${formattedDate}</div>
                        <small class="text-muted">${enrolledDate.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'})}</small>
                    </td>
                    <td>
                        <span class="badge days-badge ${durationBadge.class}">
                            <i class="fas fa-calendar-alt me-1"></i>${daysSince} days
                        </span>
                        ${daysSince < 14 ? '<small class="text-muted d-block mt-1">Can be cancelled</small>' : ''}
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                <div class="progress-bar bg-${attendanceColor}"
                                     role="progressbar"
                                     style="width: ${enrollment.attendancePercentage}%"
                                     aria-valuenow="${enrollment.attendancePercentage}"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                </div>
                            </div>
                            <span class="badge bg-${attendanceColor} badge-attendance">
                                ${enrollment.attendancePercentage}%
                            </span>
                        </div>
                        <small class="text-muted">${enrollment.attendedSessions}/${enrollment.totalSessions} sessions</small>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-light text-dark border">
                            <i class="fas fa-chalkboard-teacher me-1"></i>${enrollment.totalSessions}
                        </span>
                    </td>
                    <td class="text-center">
                        ${enrollment.canCancel ?
                `<button class="btn btn-sm btn-outline-warning me-1" onclick="showCancelModal(${enrollment.enrollmentId}, '${enrollment.studentName}')">
                                <i class="fas fa-ban me-1"></i>Cancel
                            </button>` : ''}
                        ${enrollment.canWithdraw ?
                `<button class="btn btn-sm btn-outline-danger" onclick="showWithdrawModal(${enrollment.enrollmentId}, '${enrollment.studentName}')">
                                <i class="fas fa-sign-out-alt me-1"></i>Withdraw
                            </button>` : ''}
                        ${!enrollment.canCancel && !enrollment.canWithdraw ?
                `<span class="text-muted">No action available</span>` : ''}
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    }

    function filterTable(searchTerm) {
        const filtered = allEnrollments.filter(enrollment =>
            enrollment.studentName.toLowerCase().includes(searchTerm.toLowerCase()) ||
            enrollment.studentId.toString().includes(searchTerm)
        );

        const tbody = $('#enrollments-body');
        tbody.empty();

        if (filtered.length > 0) {
            populateTable(filtered);
            $('#enrollmentCount').text(`Showing ${filtered.length} of ${allEnrollments.length} students`);
        } else {
            tbody.html(`
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <i class="fas fa-search fa-2x text-muted mb-3"></i>
                        <p class="text-muted">No students found matching "${searchTerm}"</p>
                    </td>
                </tr>
            `);
            $('#enrollmentCount').text(`No results for "${searchTerm}"`);
        }
    }

    function getAttendanceColor(percentage) {
        if (percentage >= 80) return 'success';
        if (percentage >= 60) return 'warning';
        return 'danger';
    }

    function getDurationBadge(days) {
        if (days < 14) return { class: 'days-new', icon: 'fa-clock' };
        if (days < 30) return { class: 'days-medium', icon: 'fa-calendar-week' };
        return { class: 'days-old', icon: 'fa-calendar-alt' };
    }

    function showCancelModal(enrollmentId, studentName) {
        currentEnrollmentId = enrollmentId;
        currentAction = 'cancel';

        Swal.fire({
            title: 'Cancel Enrollment',
            html: `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <p class="mb-2">Are you sure you want to cancel the enrollment for <strong>${studentName}</strong>?</p>
                    <p class="text-muted small">This action will cancel the enrollment and mark it as "Cancelled".</p>
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Note:</strong> Cancellation is only allowed within the first 2 weeks of enrollment.
                    </div>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, Cancel Enrollment',
            cancelButtonText: 'No, Keep Enrollment',
            reverseButtons: true,
            focusCancel: true,
            showLoaderOnConfirm: true,
            preConfirm: () => {
                return markEnrollment('Cancelled');
            }
        });
    }

    function showWithdrawModal(enrollmentId, studentName) {
        currentEnrollmentId = enrollmentId;
        currentAction = 'withdraw';

        Swal.fire({
            title: 'Withdraw Student',
            html: `
                <div class="text-center">
                    <i class="fas fa-user-minus fa-3x text-warning mb-3"></i>
                    <p class="mb-2">Are you sure you want to withdraw <strong>${studentName}</strong> from this course?</p>
                    <p class="text-muted small">This action will withdraw the student and mark the enrollment as "Withdrawn".</p>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Note:</strong> Withdrawal is allowed after 2 weeks of enrollment.
                    </div>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ffc107',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, Withdraw Student',
            cancelButtonText: 'No, Keep Student',
            reverseButtons: true,
            focusCancel: true,
            showLoaderOnConfirm: true,
            preConfirm: () => {
                return markEnrollment('Withdrawn');
            }
        });
    }

    function markEnrollment(status) {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: '/enrollment/mark',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    enrollmentId: currentEnrollmentId,
                    status: status
                }),
                success: function(response) {
                    resolve(response);
                },
                error: function(xhr) {
                    reject(xhr.responseJSON?.errors || 'Action failed');
                }
            });
        });
    }

    function refreshEnrollments() {
        loadEnrollments();
    }

    function showLoading() {
        $('#loading').show();
        $('#enrollments-container').hide();
        $('#no-enrollments').hide();
        $('#statsContainer').hide();
    }

    function showError(message) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: Array.isArray(message) ? message.join(', ') : message,
            confirmButtonColor: '#667eea'
        });
    }

    $(document).on('ajaxSuccess', function(event, xhr, settings, data) {
        if (settings.url === '/enrollment/mark' && data.message) {
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: data.message,
                confirmButtonColor: '#667eea',
                timer: 2000,
                timerProgressBar: true
            });
        }
    });
</script>
}
