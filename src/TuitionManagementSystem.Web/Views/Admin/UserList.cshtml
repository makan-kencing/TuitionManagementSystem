@using Microsoft.AspNetCore.Html
@model IEnumerable<TuitionManagementSystem.Web.Features.User.UserListViewModel>

@{
    ViewData["Title"] = "Manage Users";
    var currentSortColumn = ViewData["SortColumn"]?.ToString() ?? "Id";
    var currentSortOrder = ViewData["SortOrder"]?.ToString() ?? "asc";
    Func<string, string> getSortOrder = column =>
        currentSortColumn == column && currentSortOrder == "asc" ? "desc" : "asc";
    Func<string, IHtmlContent> getSortArrow = column =>
        currentSortColumn == column
            ? (currentSortOrder == "asc" ? new HtmlString(" &#9650;") : new HtmlString(" &#9660;"))
            : HtmlString.Empty;
}

<div class="container mt-4">
    <div class="d-flex justify-content-between mb-3">
        <h2>@ViewData["Title"]</h2>

        <div class="d-flex">
            <input type="text" id="searchInput" class="form-control me-2" placeholder="Search users..." />
        </div>

        <a class="btn btn-primary"
           href="@((string)ViewData["CreateUrl"])">
            + Add
        </a>
    </div>

    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>
                    <a asp-controller="Admin"
                       asp-action="UserList"
                       asp-route-sortColumn="Id"
                       asp-route-sortOrder="@getSortOrder("Id")"
                       asp-route-userType="@ViewData["UserType"]"
                       class="text-white text-decoration-none">
                        ID
                        @getSortArrow("Id")
                    </a>
                </th>
                <th>
                    <a asp-controller="Admin"
                       asp-action="UserList"
                       asp-route-sortColumn="Username"
                       asp-route-sortOrder="@getSortOrder("Username")"
                       asp-route-userType="@ViewData["UserType"]"
                       class="text-white text-decoration-none">
                        Username
                        @getSortArrow("Username")
                    </a>
                </th>
                <th>
                    <a asp-controller="Admin"
                       asp-action="UserList"
                       asp-route-sortColumn="Name"
                       asp-route-sortOrder="@getSortOrder("Name")"
                       asp-route-userType="@ViewData["UserType"]"
                       class="text-white text-decoration-none">
                        Name
                        @getSortArrow("Name")
                    </a>
                </th>
                <th>
                    <a asp-controller="Admin"
                       asp-action="UserList"
                       asp-route-sortColumn="Email"
                       asp-route-sortOrder="@getSortOrder("Email")"
                       asp-route-userType="@ViewData["UserType"]"
                       class="text-white text-decoration-none">
                        Email
                        @getSortArrow("Email")
                    </a>
                </th>
                <th class="text-end">Actions</th>
            </tr>
        </thead>

        <tbody id="userTableBody">
        @foreach (var u in Model)
        {
            <tr>
                <td>@u.Id</td>
                <td>@u.Username</td>
                <td>@(u.DisplayName ?? "-")</td>
                <td>@u.Email</td>
                <td class="text-end">
                    <a class="btn btn-sm btn-outline-primary"
                       href="@Url.Action("EditUser", "Admin", new { userId = u.Id })">
                        Edit
                    </a>
                    <button type="button"
                            class="btn btn-sm btn-outline-danger"
                            onclick="confirmDelete(@u.Id)">
                        Delete
                    </button>

                    <form id="delete-form-@u.Id"
                          asp-controller="@ViewData["UserType"]"
                          asp-action="Delete"
                          asp-route-id="@u.Id"
                          method="post"
                          class="d-none">
                        @Html.AntiForgeryToken()
                    </form>
                </td>
            </tr>
        }
        </tbody>

    </table>
</div>

@section Scripts {
<script>
    const searchInput = document.getElementById('searchInput');

    searchInput.addEventListener('keyup', function() {
        const query = searchInput.value;

        fetch(`@Url.Action("UserList", "Admin")?search=${encodeURIComponent(query)}`)
            .then(response => response.text())
            .then(html => {
                // Extract just the table rows from returned HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newTbody = doc.querySelector('#userTableBody');
                document.querySelector('#userTableBody').innerHTML = newTbody.innerHTML;
            });
    });

    function confirmDelete(id) {
        Swal.fire({
            title: 'Are you sure?',
            html: 'This user will be <b>permanently deleted</b>.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, delete',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById(`delete-form-${id}`).submit();
            }
        });
    }

    @if (TempData["Message"] != null)
    {
        <text>
        Swal.fire({
            icon: '@TempData["Status"]',
            html: '@TempData["Message"]',
            confirmButtonText: 'OK'
        });
        </text>
    }
</script>
}
